<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NextCloud-FreeIPA Docker Integration</title>
  </head>
  <body>
    <div class="main-wrapper">
      <header>
        <h1>NextCloud LDAP integration using FreeIPA and Docker</h1>
      </header>
      <figure>
        <img
          src="/static/images/wireframe.jpg"
          alt="Hand's drawing a wireframe diagram"
        />
        <figcaption>
          <span
            >Photo by
            <a
              href="https://unsplash.com/@kellysikkema?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText"
              >Kelly Sikkema</a
            >
            on
            <a
              href="https://unsplash.com/s/photos/user?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText"
              >Unsplash</a
            ></span
          >
        </figcaption>
      </figure>
      <div class="introduction">
        <h2>Introduction</h2>
        <p>
          In this tutorial you will learn how to run NextCloud and FreeIPA in
          seperate Docker containers and integrate them to enable a user saved
          in FreeIPA to log into NextCloud with the same credentials.
        </p>
      </div>
    </div>
    <div class="video-tutorial">
      <h2>Video Tutorial</h2>
      <iframe
        width="420"
        height="315"
        src="https://www.youtube.com/embed/tgbNymZ7vqY"
      >
      </iframe>
    </div>
    <div class="install-docker">
      <h2>Install Docker</h2>
      Rather than re-invent the wheel I'll point you to this guide to
      <a href="https://docs.docker.com/engine/install/ubuntu/"
        >Install Docker Engine on Ubuntu</a
      >.
    </div>
    <div class="freeipa-setup">
      <h2>FreeIPA Setup</h2>
      <p>
        First we'll create the directory which will store server data on the
        host. Open a new terminal and run
      </p>
      <div class="bash">sudo mkdir /var/lib/ipa-data</div>
      <p>We'll also add the following entry to /etc/hosts</p>
      <div class="bash">127.0.0.1 &nbsp;&nbsp; ipa.example.test ipa-server</div>
      <p>by runnning</p>
      <div class="bash">
          sudo nano /etc/hosts
      </div>
      <p>
        We'll then run the Free-IPA container with the following command (note
        some options are optional as explained below):
      </p>
      <div class="bash">
        sudo docker run -d -h ipa.example.test --name my-freeipa-server -p 80:80
        -p 443:443 -p 389:389 -v /sys/fs/cgroup:/sys/fs/cgroup:ro -v
        /var/lib/ipa-data:/data:Z -e PASSWORD=Secret123 --sysctl
        net.ipv6.conf.all.disable_ipv6=0 freeipa/freeipa-server:centos-8-4.8.7
        ipa-server-install -U -r EXAMPLE.TEST --no-ntp
      </div>
      <p>Let's run through each command in turn:</p>
      <dl>
          <dt>-d</dt>
          <dd>Optional. Runs the container in detached mode, allowing you to continue using this terminal.</dd>
          <dt>-h ipa.example.test</dt>
          <dd>Sets the hostname.</dd>
          <dt>--name my-freeipa-server</dt>
          <dd>Optional. Sets the container name to be used for Docker inspections etc.</dd>
          <dt>-p 80:80 -p 443:443 -p 389:389</dt>
          <dd>Maps ports in the contianer to ports on the host machine.</dd>
          <dt>-v /sys/fs/cgroup:/sys/fs/cgroup:ro</dt>
          <dd>May not be necessary depending on Docker version.</dd>
          <dt>-v /var/lib/ipa-data:/data:Z</dt>
          <dd>Configuration and data on volume mounted to /data directory in the container.</dd>
          <dt>-e PASSWORD=Secret123</dt>
          <dd>This will be the admin password.</dd>
          <dt>--sysctl net.ipv6.conf.all.disable_ipv6=0</dt>
          <dd>May not be neccessary. Add if you receive an error like &quot;IPv6 stack is enabled in the kernel but there is no interface that
            has ::1 address assigned&quot;</dd>
            <dt>freeipa/freeipa-server:centos-8-4.8.7</dt>
            <dd>FreeIPA image to pull from DockerHub. The tag can be changed depending on which version you want to use.</dd>
            <dt>ipa-server-install -U -r EXAMPLE.TEST --no-ntp</dt>
            <dd>FreeIPA specific install commands.</dd>
      </ul>
      <p>We can now access the FreeIPA web interface at <a href="https://ipa.example.test/ipa/ui/">https://ipa.example.test/ipa/ui/</a></p>
          <img src="/static/images/freeipa-login.png" alt="Screenshot of FreeIPA login page">  
          <p>You can now enter your admin password enterred in the Docker run command (Secret123 in our case) to access the identity management interface.</p>  
    </div>
    <div class="nextcloud-setup">
        <h2>NextCloud Setup</h2>
        <p>To setup NextCloud we'll run</p>
        <div class="bash">
            sudo docker run --name my-nextcloud-container -p 9000:80 nextcloud
        </div>
        <p>We map port 80 of the container to port 9000 of our development machine since FreeIPA is already using our local port 80.</p>
        <p>We can now access the NextCloud dashboard at <a href="http://localhost:9000">http://localhost:9000</a></p>
        <img src="/static/images/nextcloud-login.png" alt="Screenshot of NextCloud login page">
    </div>
    <div class="ldap-integration">
        <h2>NextCloud-FreeIPA LDAP integration</h2>
    </div>
    <p>When you have created an admin account as you first log in to NextCloud you can then enable LDAP by going to the apps page and enabling &quot;LDAP user and group backend&quot;</p>
    <img src="/static/images/apps.png" alt="NextCloud dropdown menu showing Apps option highlighted">
    <img src="/static/images/ldap-enable.png" alt="NextCloud option to enable LDAP user and group backend">
    <p>You can access the LDAP configuration panel via the settings under LDAP/AD integration</p>
    <img src="/static/images/settings.png" alt="NextCloud dropdown menu showing Settings option highlighted">
    <img src="/static/images/ldap-ad.png" alt="NextCloud settings menu showing LDAP/AD inegration highlighted">
    <p>We can gather some LDAP configuration details from the FreeIPA container:</p>
    <div class="bash">
      sudo docker exec my-freeipa-server ldapsearch -x uid admin
    </div>
    <img src="/static/images/ldapsearch.png" alt="Results in temrninal of running sudo docker exec my-freeipa-server ldapsearch -x uid admin">
    We'll copy &quot;uid=admin,cn=users,cn=accounts,dc=example,dc=test&quot; as we'll need that for the User DN in NextCloud.
    <p>We'll now populate the server tab with configuration details, using Secret123 for the password</p>
    <img src="/static/images/server.png" alt="Host is 172.17.0.1 Port is 80
    User DN is uid=admin,cn=users,cn=accounts,dc=example,dc=test
    Password is Secret123
    Base DN is dc=example,dc=test">
    <p>On the Users tab we'll edit the LDAP query to (|(objectclass=*))</p>
    <img src="/static/images/users-tab.png" alt="LDAP query is (|(objectclass=*))">
    <p>On the Login Attributes tab we'll edit the LDAP query to (&(|(objectclass=*))(uid=%uid))</p>
    <img src="/static/images/login-tab.png" alt="LDAP query is (&(|(objectclass=*))(uid=%uid))">
    <p>On the Groups tab we'll edit the LDAP query to (|(cn=ipausers))</p>
    <img src="/static/images/groups-tab.png" alt="LDAP query is (|(cn=ipausers))">
  </div>
  <p>Next, we'll go to the Advanced tab and ensure the Configuration Active box is checked</p>
  <img src="/static/images/connection-settings.png" alt="Checked Configuration Active box">
  <p>Under directory settings we'll set Base User Tree to
    cn=users,cn=accounts,dc=example,dc=test</p>
    And we'll set Base Group Tree to cn=groups,cn=accounts,dc=example,dc=test</p>
    <p>We'll also set Group-Member association to uniqueMember</p>
    <img src="/static/images/directory-settings.png" alt="Direcotry Settings tab showing Base User Tree as
    cn=users,cn=accounts,dc=example,dc=test and Base Group Tree as cn=groups,cn=accounts,dc=example,dc=test and Group-Member association set to uniqueMember">
    <p>In the Special Attributes section we'll set the Email Field to mail and User Home Folder Naming Rule to cn</p>
    <img src="/static/images/special-attributes.png" alt="Special Attributes tab showing Email Field set to mail and User Home Folder Naming Rule set to cn">
    <p>You should now see the Configuration OK message</p>
    <img src="/static/images/configuration-ok.png" alt="Configuration OK message">
    <p>Users can now log into NextCloud using their credentials stored in FreeIPA. You can test this by adding a new user to FreeIPA or logging into NextCloud with your FreeIPA admin credentials (username: admin, password: Secret123).</p>
    <img src="/static/images/adminlogin.png" alt="NextCloud message showing Good Afternoon, Administrator">
  </body>
</html>
